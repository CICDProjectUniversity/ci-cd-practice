name: Auto Merge

on:
  pull_request:
    types:
      - labeled
      - unlabeled
      - synchronize
      - opened
      - edited
      - ready_for_review
      - reopened
      - unlocked
  pull_request_review:
    types:
      - submitted
  check_suite:
    types:
      - completed
  status: {}
  workflow_dispatch:

jobs:
  # Job 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –¥–ª—è –∞–≤—Ç–æ–º–µ—Ä–¥–∂–∞
  check-conditions:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –∞–≤—Ç–æ–º–µ—Ä–¥–∂–∞
    runs-on: ubuntu-latest
    outputs:
      should_merge: ${{ steps.check.outputs.should_merge }}
    
    steps:
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π
      id: check
      run: |
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –¥–ª—è –∞–≤—Ç–æ–º–µ—Ä–¥–∂–∞ ==="
        echo "Event: ${{ github.event_name }}"
        echo "PR Number: ${{ github.event.pull_request.number || 'N/A' }}"
        echo "Actor: ${{ github.actor }}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ª–µ–π–±–ª automerge
        if [[ "${{ contains(github.event.pull_request.labels.*.name, 'automerge') }}" == "true" ]]; then
          echo "‚úÖ –õ–µ–π–±–ª 'automerge' –Ω–∞–π–¥–µ–Ω"
          echo "should_merge=true" >> $GITHUB_OUTPUT
        else
          echo "‚ùå –õ–µ–π–±–ª 'automerge' –Ω–µ –Ω–∞–π–¥–µ–Ω"
          echo "should_merge=false" >> $GITHUB_OUTPUT
        fi

  # Job 2: –ê–≤—Ç–æ–º–µ—Ä–¥–∂ –¥–ª—è Dependabot
  automerge-dependabot:
    name: –ê–≤—Ç–æ–º–µ—Ä–¥–∂ Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]' || github.actor == 'dependabot-preview[bot]'
    
    steps:
    - name: ü§ñ Dependabot –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
      id: metadata
      uses: dependabot/fetch-metadata@v1
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"
    
    - name: ‚úÖ –û–¥–æ–±—Ä–µ–Ω–∏–µ Dependabot PR
      if: steps.metadata.outputs.update-type == 'version-update:semver-minor' || steps.metadata.outputs.update-type == 'version-update:semver-patch'
      run: |
        gh pr review --approve "$PR_URL"
        gh pr comment "$PR_URL" --body "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–¥–æ–±—Ä–µ–Ω–æ ü§ñ 
        
        **–¢–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** ${{ steps.metadata.outputs.update-type }}
        **–ü–∞–∫–µ—Ç:** ${{ steps.metadata.outputs.dependency-names }}
        
        PR –±—É–¥–µ—Ç —Å–º–µ—Ä–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫."
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: üîÄ –ê–≤—Ç–æ–º–µ—Ä–¥–∂ Dependabot PR
      if: steps.metadata.outputs.update-type == 'version-update:semver-minor' || steps.metadata.outputs.update-type == 'version-update:semver-patch'
      run: |
        gh pr merge --auto --merge "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 3: –ê–≤—Ç–æ–º–µ—Ä–¥–∂ —Å –ª–µ–π–±–ª–æ–º
  automerge-labeled:
    name: –ê–≤—Ç–æ–º–µ—Ä–¥–∂ PR —Å –ª–µ–π–±–ª–æ–º
    runs-on: ubuntu-latest
    needs: check-conditions
    if: |
      needs.check-conditions.outputs.should_merge == 'true' &&
      github.event.pull_request.draft == false
    
    steps:
    - name: üì• Checkout –∫–æ–¥–∞
      uses: actions/checkout@v4
    
    - name: ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫
      uses: lewagon/wait-on-check-action@v1.3.1
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        check-name: '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Python 3.10'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        wait-interval: 10
    
    - name: üîÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ä–¥–∂
      uses: pascalgn/merge-action@v0.15.6
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        MERGE_LABELS: "automerge,!do-not-merge,!work-in-progress"
        MERGE_METHOD: "squash"
        MERGE_COMMIT_MESSAGE: |
          Auto-merge PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}
          
          ${{ github.event.pull_request.body }}
          
          Co-authored-by: ${{ github.event.pull_request.user.login }} <${{ github.event.pull_request.user.email }}>
        MERGE_RETRIES: "3"
        MERGE_RETRY_SLEEP: "10000"
        UPDATE_LABELS: "automerged"
        UPDATE_METHOD: "merge"
        MERGE_DELETE_BRANCH: "true"
    
    - name: üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –º–µ—Ä–¥–∂–µ
      if: success()
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ‚úÖ PR —É—Å–ø–µ—à–Ω–æ —Å–º–µ—Ä–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
            
            **–í—Ä–µ–º—è:** ${new Date().toISOString()}
            **–ú–µ—Ç–æ–¥:** Squash and merge
            **–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞
            
            –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤–∫–ª–∞–¥! üéâ`
          })

  # Job 4: –ê–≤—Ç–æ–º–µ—Ä–¥–∂ —Å GitHub native auto-merge
  enable-auto-merge:
    name: –í–∫–ª—é—á–µ–Ω–∏–µ GitHub Auto-merge
    runs-on: ubuntu-latest
    if: | 
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.labels.*.name, 'auto-merge-native')
    
    steps:
    - name: üîì –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
      id: generate_token
      uses: tibdex/github-app-token@v1
      with:
        app_id: ${{ secrets.APP_ID }}
        private_key: ${{ secrets.APP_PRIVATE_KEY }}
      continue-on-error: true
    
    - name: üîÄ –í–∫–ª—é—á–µ–Ω–∏–µ auto-merge
      uses: alexwilson/enable-github-automerge-action@1.0.0
      with:
        github-token: "${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}"
        pull-request-number: ${{ github.event.pull_request.number }}
        merge-method: "SQUASH"

  # Job 5: –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –º–µ—Ä–¥–∂–∞
  cleanup:
    name: –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –º–µ—Ä–¥–∂–∞
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    
    steps:
    - name: üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –≤–µ—Ç–∫–∏
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const branch = context.payload.pull_request.head.ref;
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          
          try {
            await github.rest.git.deleteRef({
              owner: owner,
              repo: repo,
              ref: `heads/${branch}`
            });
            console.log(`‚úÖ –í–µ—Ç–∫–∞ ${branch} —É–¥–∞–ª–µ–Ω–∞`);
          } catch (error) {
            console.log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≤–µ—Ç–∫—É: ${error.message}`);
          }
    
    - name: üìã –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // –î–æ–±–∞–≤—å—Ç–µ PR –≤ –ø—Ä–æ–µ–∫—Ç "Completed"
          console.log('PR #${{ github.event.pull_request.number }} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ');
