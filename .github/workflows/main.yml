name: CI/CD Pipeline

on:
  push:
    branches: [ main, development, release ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å workflow –≤—Ä—É—á–Ω—É—é

env:
  PYTHON_VERSION: '3.10'

jobs:
  # Job 1: –õ–∏–Ω—Ç–∏–Ω–≥ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
  lint:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout –∫–æ–¥–∞
      uses: actions/checkout@v4
    
    - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–∏–Ω—Ç–µ—Ä–æ–≤
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint black isort
    
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
      run: |
        python -m py_compile app.py
        python -m py_compile test_app.py
    
    - name: üé® –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (Black)
      run: |
        black --check app.py test_app.py || true
    
    - name: üìã –õ–∏–Ω—Ç–∏–Ω–≥ (Flake8)
      run: |
        flake8 app.py test_app.py --max-line-length=100 --ignore=E501,W503 || true

  # Job 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  test:
    name: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    needs: lint
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11']
        exclude:
          # –ò—Å–∫–ª—é—á–∞–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
          - os: windows-latest
            python-version: '3.8'
          - os: macos-latest
            python-version: '3.8'
    
    steps:
    - name: üì• Checkout –∫–æ–¥–∞
      uses: actions/checkout@v4
    
    - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: üíæ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-cov
    
    - name: üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
      run: |
        pytest test_app.py -v --cov=app --cov-report=xml --cov-report=html --cov-report=term
    
    - name: üìä –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.10'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/
    
    - name: üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º (–¥–ª—è PR)
      if: github.event_name == 'pull_request' && matrix.os == 'ubuntu-latest' && matrix.python-version == '3.10'
      uses: py-cov-action/python-coverage-comment-action@v3
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        MINIMUM_GREEN: 80
        MINIMUM_ORANGE: 50

  # Job 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
  docs:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: üì• Checkout –∫–æ–¥–∞
      uses: actions/checkout@v4
    
    - name: üìö –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
      run: |
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ==="
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
        files_to_check=("README.md")
        
        for file in "${files_to_check[@]}"; do
          if [ -f "$file" ]; then
            echo "‚úÖ $file –Ω–∞–π–¥–µ–Ω"
            # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø—É—Å—Ç–æ–π
            if [ -s "$file" ]; then
              echo "   ‚îî‚îÄ –§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ ($(wc -l < $file) —Å—Ç—Ä–æ–∫)"
            else
              echo "   ‚îî‚îÄ ‚ö†Ô∏è  –§–∞–π–ª –ø—É—Å—Ç–æ–π!"
            fi
          else
            echo "‚ö†Ô∏è $file –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
          fi
        done
        
        echo ""
        echo "=== –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ==="
        find . -name "*.md" -type f | while read file; do
          lines=$(wc -l < "$file")
          echo "üìÑ $file: $lines —Å—Ç—Ä–æ–∫"
        done

  # Job 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  security:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: üì• Checkout –∫–æ–¥–∞
      uses: actions/checkout@v4
    
    - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        pip install safety bandit
        pip install -r requirements.txt
        
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö ==="
        safety check --json || true
        
        echo ""
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞ ==="
        bandit -r app.py -f json || true

  # Job 5: –°–±–æ—Ä–∫–∞ –∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
  build:
    name: –°–±–æ—Ä–∫–∞ –∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    runs-on: ubuntu-latest
    needs: [test, docs, security]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: üì• Checkout –∫–æ–¥–∞
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏
    
    - name: üè∑Ô∏è –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏
      id: version
      run: |
        if [ -f "VERSION" ]; then
          VERSION=$(cat VERSION)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìå –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: $VERSION"
        else
          echo "version=1.0.0" >> $GITHUB_OUTPUT
          echo "üìå –í–µ—Ä—Å–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1.0.0"
        fi
    
    - name: üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
      run: |
        mkdir -p dist
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ —Å –∫–æ–¥–æ–º
        tar -czf dist/app-${{ steps.version.outputs.version }}.tar.gz \
          app.py test_app.py requirements.txt README.md
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        echo "Build Information" > dist/build-info.txt
        echo "=================" >> dist/build-info.txt
        echo "Version: ${{ steps.version.outputs.version }}" >> dist/build-info.txt
        echo "Build Date: $(date)" >> dist/build-info.txt
        echo "Git Commit: ${{ github.sha }}" >> dist/build-info.txt
        echo "Git Branch: ${{ github.ref_name }}" >> dist/build-info.txt
        echo "Build Number: ${{ github.run_number }}" >> dist/build-info.txt
    
    - name: üì§ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ steps.version.outputs.version }}
        path: dist/
        retention-days: 30

  # Job 6: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  notify:
    name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    runs-on: ubuntu-latest
    needs: [build]
    if: always()
    
    steps:
    - name: üìä –°—Ç–∞—Ç—É—Å —Å–±–æ—Ä–∫–∏
      run: |
        echo "=== –†–µ–∑—É–ª—å—Ç–∞—Ç—ã CI/CD Pipeline ==="
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Run Number: ${{ github.run_number }}"
        echo "Status: ${{ job.status }}"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "‚úÖ Pipeline –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
        else
          echo "‚ùå Pipeline –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!"
        fi
